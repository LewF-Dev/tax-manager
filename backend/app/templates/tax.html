{% extends "base.html" %}

{% block title %}Your Tax - Tax Manager{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-6">Your Tax</h2>

    <!-- Tax Year Info -->
    <div class="bg-blue-50 dark:bg-blue-900 border-l-4 border-blue-400 dark:border-blue-600 rounded-lg p-4 mb-8">
        <p class="text-sm text-blue-900 dark:text-blue-100">
            <strong>{{ tax_summary.tax_year }} Tax Year</strong> runs from {{ tax_summary.tax_year_start.strftime('%d %B %Y') }} to {{ tax_summary.tax_year_end.strftime('%d %B %Y') }}.
            These are estimates based on current HMRC rules.
        </p>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- Income & Expenses -->
        <div class="bg-gradient-to-br from-blue-50 to-white dark:from-blue-900 dark:to-gray-800 rounded-lg border border-blue-200 dark:border-blue-700 p-6 card-hover">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Your Money</h3>
            <div class="space-y-3">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400">Money In</span>
                    <span class="font-medium text-blue-600 dark:text-blue-400 amount">£{{ "%.2f"|format(tax_summary.total_income) }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400">Expenses</span>
                    <span class="font-medium text-green-600 dark:text-green-400 amount">£{{ "%.2f"|format(tax_summary.total_expenses) }}</span>
                </div>
                <div class="pt-3 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between">
                        <span class="font-medium text-gray-900 dark:text-white flex items-center gap-1">
                            What You Keep
                            <span class="info-tooltip cursor-help">
                                <svg class="w-4 h-4 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="tooltip-content">This is your profit - what's left after taking away business expenses from your income. This is the amount HMRC uses to calculate your tax.</span>
                            </span>
                        </span>
                        <span class="font-semibold text-gray-900 dark:text-white amount">£{{ "%.2f"|format(tax_summary.net_profit) }}</span>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Before tax</p>
                </div>
            </div>
        </div>

        <!-- Tax Breakdown -->
        <div class="bg-gradient-to-br from-yellow-50 to-white dark:from-yellow-900 dark:to-gray-800 rounded-lg border border-yellow-200 dark:border-yellow-700 p-6 card-hover">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Tax Bill Estimate</h3>
            <div class="space-y-3">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400 flex items-center gap-1">
                        Income Tax
                        <span class="info-tooltip cursor-help">
                            <svg class="w-4 h-4 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="tooltip-content">Tax on your profit. You don't pay tax on the first £12,570 (Personal Allowance). After that, you pay 20% on earnings up to £50,270, then 40% on higher amounts.</span>
                        </span>
                    </span>
                    <span class="font-medium text-gray-900 dark:text-white amount">£{{ "%.2f"|format(tax_summary.income_tax) }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400 flex items-center gap-1">
                        National Insurance (Class 2)
                        <span class="info-tooltip cursor-help">
                            <svg class="w-4 h-4 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="tooltip-content">A fixed weekly payment (£3.45) that self-employed people pay if they earn over £6,725 a year. This counts towards your State Pension and other benefits.</span>
                        </span>
                    </span>
                    <span class="font-medium text-gray-900 dark:text-white amount">£{{ "%.2f"|format(tax_summary.ni_class2) }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400 flex items-center gap-1">
                        National Insurance (Class 4)
                        <span class="info-tooltip cursor-help">
                            <svg class="w-4 h-4 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="tooltip-content">An additional National Insurance payment based on your profit. You pay 9% on profits between £12,570 and £50,270, then 2% on anything above that.</span>
                        </span>
                    </span>
                    <span class="font-medium text-gray-900 dark:text-white amount">£{{ "%.2f"|format(tax_summary.ni_class4) }}</span>
                </div>
                <div class="pt-3 border-t border-gray-200">
                    <div class="flex justify-between">
                        <span class="font-medium text-gray-900">Total to Pay</span>
                        <span class="font-semibold text-yellow-700 amount">£{{ "%.2f"|format(tax_summary.total_tax) }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tax to Set Aside -->
    <div class="bg-gradient-to-br from-green-50 to-white dark:from-green-900 dark:to-gray-800 rounded-lg border border-green-200 dark:border-green-700 p-6 mb-8 card-hover">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Money Saved for Tax</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">You're saving {{ user.tax_set_aside_percentage }}% of what you earn</p>
            </div>
            <div class="text-right">
                <div class="text-3xl font-semibold text-green-700 dark:text-green-400 amount">£{{ "%.2f"|format(tax_summary.tax_to_set_aside) }}</div>
            </div>
        </div>
        <p class="text-sm text-gray-600 dark:text-gray-400">
            {% if tax_summary.tax_to_set_aside > tax_summary.total_tax %}
            ✅ You're saving more than your estimated tax bill. This gives you a safety buffer.
            {% elif tax_summary.tax_to_set_aside < tax_summary.total_tax %}
            <span class="text-yellow-700">⚠️ Your savings might not cover your tax bill. Consider increasing your percentage in Settings.</span>
            {% else %}
            ✅ Your savings match your estimated tax bill.
            {% endif %}
        </p>
    </div>

    <!-- How This is Calculated -->
    <div class="bg-white rounded-lg border border-gray-200 mb-8 card-hover">
        <button 
            onclick="document.getElementById('calculation-details').classList.toggle('hidden')"
            class="w-full px-6 py-4 text-left flex justify-between items-center hover:bg-gray-50 transition-colors"
        >
            <span class="text-lg font-medium text-gray-900">How We Calculate Your Tax</span>
            <span class="text-gray-400">▼</span>
        </button>
        <div id="calculation-details" class="hidden px-6 py-4 border-t border-gray-200 space-y-4 text-sm">
            <div>
                <h4 class="font-medium text-gray-900 mb-2">Income Tax</h4>
                <p class="text-gray-600 mb-2">Based on your net profit of £{{ "%.2f"|format(tax_summary.net_profit) }}:</p>
                <ul class="list-disc list-inside text-gray-600 space-y-1 ml-4">
                    <li>Personal Allowance: £12,570 (tax-free)</li>
                    <li>Basic rate (20%): £12,571 - £50,270</li>
                    <li>Higher rate (40%): £50,271 - £125,140</li>
                    <li>Additional rate (45%): Over £125,140</li>
                </ul>
            </div>
            <div>
                <h4 class="font-medium text-gray-900 mb-2">National Insurance Class 2</h4>
                <p class="text-gray-600">
                    Flat weekly rate of £3.45 (£179.40 per year) if profits exceed £6,725.
                </p>
            </div>
            <div>
                <h4 class="font-medium text-gray-900 mb-2">National Insurance Class 4</h4>
                <p class="text-gray-600 mb-2">Based on profits:</p>
                <ul class="list-disc list-inside text-gray-600 space-y-1 ml-4">
                    <li>9% on profits between £12,570 and £50,270</li>
                    <li>2% on profits over £50,270</li>
                </ul>
            </div>
            <div class="pt-4 border-t border-gray-200">
                <p class="text-xs text-gray-500">
                    These calculations use the {{ tax_summary.tax_year }} tax year rates. 
                    Rates are updated when HMRC announces changes.
                </p>
            </div>
        </div>
    </div>

    <!-- HMRC Registration -->
    {% if user.trading_start_date %}
    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6 mb-8 card-hover">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            Register with HMRC
            <span class="info-tooltip cursor-help">
                <svg class="w-4 h-4 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
                <span class="tooltip-content">HMRC (Her Majesty's Revenue and Customs) is the UK tax authority. You must register for Self Assessment by 5 October after the tax year you started working for yourself.</span>
            </span>
        </h3>
        <div class="space-y-2 text-sm">
            <div class="flex justify-between">
                <span class="text-gray-600">Trading started</span>
                <span class="font-medium text-gray-900">{{ user.trading_start_date.strftime('%d %B %Y') }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Registration deadline</span>
                <span class="font-medium text-gray-900">{{ tax_summary.hmrc_registration_deadline.strftime('%d %B %Y') }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Days remaining</span>
                <span class="font-medium {% if days_until_hmrc_deadline < 30 %}text-red-600{% else %}text-gray-900{% endif %}">
                    {{ days_until_hmrc_deadline }} days
                </span>
            </div>
        </div>
        <p class="text-xs text-gray-500 mt-4">
            You must register for Self Assessment by 5 October following the end of the tax year you started trading.
        </p>
    </div>
    {% endif %}

    <!-- VAT Threshold -->
    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6 card-hover">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            VAT Registration
            <span class="info-tooltip cursor-help">
                <svg class="w-4 h-4 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
                <span class="tooltip-content">VAT (Value Added Tax) is a 20% tax you add to your prices. You must register if your turnover exceeds £90,000 in 12 months. Once registered, you charge VAT to customers and pay it to HMRC.</span>
            </span>
        </h3>
        <div class="mb-4">
            <div class="flex justify-between text-sm mb-2">
                <span class="text-gray-600">Current turnover</span>
                <span class="font-medium text-gray-900 amount">£{{ "%.2f"|format(tax_summary.total_income) }}</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div 
                    class="h-2 rounded-full {% if tax_summary.vat_threshold_proximity > 90 %}bg-red-500{% elif tax_summary.vat_threshold_proximity > 80 %}bg-yellow-500{% else %}bg-gray-400{% endif %}"
                    style="width: {{ [tax_summary.vat_threshold_proximity, 100]|min }}%"
                ></div>
            </div>
            <div class="flex justify-between text-xs text-gray-500 mt-1">
                <span>£0</span>
                <span>£85,000 threshold</span>
            </div>
        </div>
        <p class="text-sm text-gray-600">
            {% if tax_summary.vat_threshold_proximity > 90 %}
            <span class="text-red-700 font-medium">⚠️ You're approaching the VAT registration threshold.</span>
            You must register if turnover exceeds £90,000 in a 12-month period.
            {% elif tax_summary.vat_threshold_proximity > 80 %}
            <span class="text-yellow-700 font-medium">You're approaching the VAT registration threshold.</span>
            Monitor your turnover carefully.
            {% else %}
            You're {{ "%.1f"|format(tax_summary.vat_threshold_proximity) }}% of the way to the £85,000 VAT threshold.
            {% endif %}
        </p>
    </div>
</div>
{% endblock %}
