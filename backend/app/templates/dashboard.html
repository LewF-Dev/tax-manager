{% extends "base.html" %}

{% block title %}Dashboard - Tax Manager{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Status Summary -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Your Account</h2>
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 space-y-3 shadow-md card-hover">
            <div class="flex justify-between text-sm">
                <span class="text-gray-600 dark:text-gray-400 flex items-center gap-1">
                    Tax year
                    <span class="info-tooltip cursor-help">
                        <svg class="w-4 h-4 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="tooltip-content">The UK tax year runs from 6 April to 5 April the following year. This is the period HMRC uses to calculate your tax.</span>
                    </span>
                </span>
                <span class="font-medium text-gray-900 dark:text-white">{{ tax_summary.tax_year }}</span>
            </div>
            {% if user.uc_enabled %}
            <div class="flex justify-between text-sm">
                <span class="text-gray-600 dark:text-gray-400">Benefits tracking</span>
                <span class="font-medium text-green-700 dark:text-green-400">On</span>
            </div>
            {% endif %}
            <div class="flex justify-between text-sm">
                <span class="text-gray-600 dark:text-gray-400">Account status</span>
                <span class="font-medium text-gray-900 dark:text-white">{{ user.subscription_status|title }}</span>
            </div>
            {% if user.trading_start_date %}
            <div class="flex justify-between text-sm">
                <span class="text-gray-600 dark:text-gray-400">Self-employed since</span>
                <span class="font-medium text-gray-900 dark:text-white">{{ user.trading_start_date.strftime('%d %B %Y') }}</span>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- The Three Numbers That Matter -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Your Money This Year</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 stagger-children">
            <!-- Total Income -->
            <div class="bg-gradient-to-br from-blue-50 to-white dark:from-blue-900 dark:to-gray-800 rounded-xl border-2 border-blue-200 dark:border-blue-700 p-6 shadow-lg card-hover">
                <div class="text-sm text-blue-700 dark:text-blue-300 mb-3 font-semibold uppercase tracking-wide">Money In</div>
                <div class="text-4xl font-bold text-gray-900 dark:text-white amount mb-2">£{{ "%.2f"|format(tax_summary.total_income) }}</div>
                <div class="text-xs text-gray-600 dark:text-gray-400 mt-2">Total earned</div>
            </div>

            <!-- Tax Savings Status -->
            <div class="bg-gradient-to-br from-yellow-50 to-white dark:from-yellow-900 dark:to-gray-800 rounded-xl border-2 border-yellow-200 dark:border-yellow-700 p-6 shadow-lg card-hover">
                <div class="text-sm text-yellow-700 dark:text-yellow-300 mb-3 font-semibold uppercase tracking-wide flex items-center gap-1">
                    Tax Savings
                    <span class="info-tooltip cursor-help">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="tooltip-content">How much you've actually saved vs your estimated tax bill.</span>
                    </span>
                </div>
                <div class="flex items-baseline gap-2 mb-2">
                    <div class="text-4xl font-bold {% if tax_summary.actual_tax_saved >= tax_summary.total_tax %}text-green-600 dark:text-green-400{% else %}text-orange-600 dark:text-orange-400{% endif %} amount">
                        £{{ "%.2f"|format(tax_summary.actual_tax_saved) }}
                    </div>
                    <div class="text-lg text-gray-500 dark:text-gray-400">/ £{{ "%.2f"|format(tax_summary.total_tax) }}</div>
                </div>
                <div class="text-xs text-gray-600 dark:text-gray-400 mt-2">
                    {% if tax_summary.actual_tax_saved >= tax_summary.total_tax %}
                    ✅ Tax bill covered
                    {% elif tax_summary.actual_tax_saved == 0 %}
                    ⚠️ No savings recorded yet
                    {% else %}
                    ⚠️ Need £{{ "%.2f"|format(tax_summary.total_tax - tax_summary.actual_tax_saved) }} more
                    {% endif %}
                </div>
            </div>

            <!-- Estimated Tax -->
            <div class="bg-gradient-to-br from-green-50 to-white dark:from-green-900 dark:to-gray-800 rounded-xl border-2 border-green-200 dark:border-green-700 p-6 shadow-lg card-hover">
                <div class="text-sm text-green-700 dark:text-green-300 mb-3 font-semibold uppercase tracking-wide flex items-center gap-1">
                    Tax Bill Estimate
                    <span class="info-tooltip cursor-help">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="tooltip-content">This is an estimate of what you'll owe HMRC. It includes Income Tax and National Insurance based on your profit (income minus expenses). The actual amount may vary.</span>
                    </span>
                </div>
                <div class="text-4xl font-bold text-gray-900 dark:text-white amount mb-2">£{{ "%.2f"|format(tax_summary.total_tax) }}</div>
                <div class="text-xs text-gray-600 dark:text-gray-400 mt-2">After £{{ "%.2f"|format(tax_summary.total_expenses) }} expenses</div>
            </div>
        </div>
    </div>

    <!-- UC Status (if enabled) -->
    {% if user.uc_enabled and uc_period %}
    <div class="mb-8">
        <h2 class="text-2xl font-semibold text-gray-900 mb-4">Universal Credit</h2>
        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <div class="text-sm text-gray-600">Current Assessment Period</div>
                    <div class="text-lg font-medium text-gray-900">
                        {{ uc_period.period_start.strftime('%d %b') }} - {{ uc_period.period_end.strftime('%d %b %Y') }}
                    </div>
                </div>
                {% if uc_period.reported_at %}
                <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">Reported</span>
                {% else %}
                <span class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-800">Not Reported</span>
                {% endif %}
            </div>
            <div class="grid grid-cols-3 gap-4 text-sm">
                <div>
                    <div class="text-gray-600">Income</div>
                    <div class="font-medium text-gray-900 amount">£{{ "%.2f"|format(uc_period.total_income) }}</div>
                </div>
                <div>
                    <div class="text-gray-600">Expenses</div>
                    <div class="font-medium text-gray-900 amount">£{{ "%.2f"|format(uc_period.total_expenses) }}</div>
                </div>
                <div>
                    <div class="text-gray-600">Net Profit</div>
                    <div class="font-medium text-gray-900 amount">£{{ "%.2f"|format(uc_period.net_profit) }}</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Next Actions -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Next Actions</h2>
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 divide-y divide-gray-200 dark:divide-gray-700 shadow-md">
            {% if recommended_percentage > user.tax_set_aside_percentage %}
            <div class="p-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <span class="inline-block w-2 h-2 mt-2 bg-orange-500 rounded-full"></span>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-gray-900 dark:text-gray-100">Consider increasing your tax savings to {{ recommended_percentage }}%</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">{{ recommendation_reason }}</p>
                        <a href="/settings" class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300">Update in Settings →</a>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if not user.trading_start_date %}
            <div class="p-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <span class="inline-block w-2 h-2 mt-2 bg-blue-500 rounded-full"></span>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-gray-900 dark:text-gray-100">Set your trading start date</p>
                        <a href="/settings" class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300">Go to Settings →</a>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if user.uc_enabled and uc_period and not uc_period.reported_at %}
            <div class="p-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <span class="inline-block w-2 h-2 mt-2 bg-yellow-500 rounded-full"></span>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-gray-900">UC report not yet marked as reported</p>
                        <a href="/uc" class="text-sm text-blue-600 hover:text-blue-700">Go to Universal Credit →</a>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if user.trading_start_date and days_until_hmrc_deadline %}
            <div class="p-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <span class="inline-block w-2 h-2 mt-2 {% if days_until_hmrc_deadline < 30 %}bg-red-500{% else %}bg-gray-400{% endif %} rounded-full"></span>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-gray-900">
                            HMRC registration deadline: {{ tax_summary.hmrc_registration_deadline.strftime('%d %B %Y') }}
                        </p>
                        <p class="text-xs text-gray-600">{{ days_until_hmrc_deadline }} days remaining</p>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if tax_summary.vat_threshold_proximity > 80 %}
            <div class="p-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <span class="inline-block w-2 h-2 mt-2 bg-yellow-500 rounded-full"></span>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-gray-900">Approaching VAT registration threshold</p>
                        <p class="text-xs text-gray-600">{{ "%.1f"|format(tax_summary.vat_threshold_proximity) }}% of £85,000 threshold</p>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if recent_income_count == 0 %}
            <div class="p-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <span class="inline-block w-2 h-2 mt-2 bg-gray-400 rounded-full"></span>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-gray-900">No income recorded this month</p>
                        <a href="/income" class="text-sm text-blue-600 hover:text-blue-700">Add Income →</a>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if not next_actions_exist %}
            <div class="p-4">
                <p class="text-sm text-gray-600">No actions required. Everything is up to date.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <a href="/income" class="block p-6 bg-gradient-to-br from-blue-50 to-white dark:from-blue-900 dark:to-gray-800 rounded-xl border-2 border-blue-200 dark:border-blue-700 hover:border-blue-300 dark:hover:border-blue-600 shadow-md card-hover transition-all">
            <div class="text-base font-semibold text-blue-700 dark:text-blue-300 mb-1">Add Money In</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Record a payment received</div>
        </a>
        <a href="/expenses" class="block p-6 bg-gradient-to-br from-green-50 to-white dark:from-green-900 dark:to-gray-800 rounded-xl border-2 border-green-200 dark:border-green-700 hover:border-green-300 dark:hover:border-green-600 shadow-md card-hover transition-all">
            <div class="text-base font-semibold text-green-700 dark:text-green-300 mb-1">Add Expense</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Record a payment made</div>
        </a>
        <a href="/tax" class="block p-6 bg-gradient-to-br from-purple-50 to-white dark:from-purple-900 dark:to-gray-800 rounded-xl border-2 border-purple-200 dark:border-purple-700 hover:border-purple-300 dark:hover:border-purple-600 shadow-md card-hover transition-all">
            <div class="text-base font-semibold text-purple-700 dark:text-purple-300 mb-1">Check Tax</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">View your tax summary</div>
        </a>
    </div>
</div>
{% endblock %}
